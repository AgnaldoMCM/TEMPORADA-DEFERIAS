rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Regras para a coleção 'registrations'
    match /registrations/{registrationId} {
      
      // PERMISSÕES DE LEITURA (get, list)
      // Apenas usuários autenticados (admins) podem ler os dados.
      allow read: if request.auth != null;

      // PERMISSÃO DE CRIAÇÃO (create)
      // Qualquer pessoa pode criar um novo registro (inscrição).
      // Adicionamos validações para garantir a integridade dos dados iniciais.
      allow create: if request.resource.data.name is string
                      && request.resource.data.email is string
                      && request.resource.data.phone is string
                      && request.resource.data.paymentConfirmed == false
                      && request.resource.data.createdAt == request.time;

      // PERMISSÕES DE ESCRITA (update, delete)
      // Ninguém pode atualizar ou deletar registros diretamente do client-side.
      // A atualização do pagamento é feita de forma segura pelo backend (webhook), que ignora estas regras.
      allow update, delete: if false;
    }
  }
}
